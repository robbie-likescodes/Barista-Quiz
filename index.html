<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#111827" />
  <title>Barista Flashcards & Quizzes</title>

  <!-- Cache-busting versions: bump when you redeploy -->
  <link rel="stylesheet" href="styles.css?v=38" />
  <script defer src="app.js?v=35"></script>
</head>
<body>
  <noscript><div class="noscript">This app requires JavaScript.</div></noscript>

  <!-- Header / Brand / Mobile menu -->
  <header class="app-header" role="banner">
    <div class="brand">
      <span class="logo" aria-hidden="true">☕</span>
      <h1>Barista Flashcards &amp; Quizzes</h1>
    </div>

    <!-- Student-only top actions -->
    <div class="student-nav" aria-label="Student actions">
      <button class="btn student-nav-btn" data-route="practice">Practice</button>
      <button class="btn student-nav-btn" data-route="quiz">Take Quiz</button>
      <button class="btn student-nav-btn" data-route="grades">History</button>
      <button class="btn student-nav-btn" data-route="leaderboards">Leaderboards</button>
    </div>

    <!-- Compact top nav: dropdown menu on mobile; all handled by CSS/JS -->
    <div class="topnav">
      <div class="menu">
        <button id="menuBtn" class="btn ghost" aria-haspopup="true" aria-expanded="false">Menu ≡</button>
        <div id="menuList" class="menu-list" role="menu" aria-label="Primary">
          <button class="menu-item active" data-route="create" role="menuitem">Create</button>
          <button class="menu-item" data-route="build" role="menuitem">Quiz Builder</button>
          <button class="menu-item" data-route="quizzes" role="menuitem">Quizzes</button>
          <button class="menu-item" data-route="practice" role="menuitem">Practice</button>
          <button class="menu-item" data-route="quiz" role="menuitem">Quiz</button>
          <button class="menu-item" data-route="reports" role="menuitem">Reports</button>
          <button class="menu-item" data-route="grades" role="menuitem">Grades</button>
          <button class="menu-item" data-route="settings" role="menuitem">Settings</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <div id="liveRegion" class="sr-only" aria-live="polite"></div>

    <!-- ========================= CREATE ========================= -->
    <section id="view-create" class="view active" aria-labelledby="create-title">
      <h2 id="create-title">Content Library</h2>

      <div class="card primary-card">
        <div class="card-head">
          <strong>Add / Select a Deck (merged by Deck Name)</strong>
          <div class="grow"></div>

          <!-- Deck actions -->
          <button id="renameDeckBtn" class="btn ghost">Rename</button>
          <button id="editDeckMetaBtn" class="btn ghost">Edit Meta</button>
          <button id="deleteDeckBtn" class="btn danger">Delete</button>
          <button id="exportDeckBtn" class="btn">Export</button>
          <button id="importDeckBtn" class="btn">Import…</button>
          <input id="importDeckInput" type="file" accept=".json,.txt" hidden>
          <!-- JS injects: Export All / Import Backup… buttons + hidden backup input -->
        </div>

        <div class="grid g2 mt">
          <div>
            <label class="label" for="newClassName">Class</label>
            <input id="newClassName" class="input" list="classNames" placeholder="e.g., Barista Training" autocomplete="off" />
            <datalist id="classNames"></datalist>
          </div>
          <div>
            <label class="label" for="newDeckName">Deck (merged by name)</label>
            <input id="newDeckName" class="input" list="deckNames" placeholder="e.g., Hot Drinks" autocomplete="off" />
            <datalist id="deckNames"></datalist>
          </div>
        </div>

        <div class="grid g2 mt">
          <div class="subcat-wrap">
            <button id="toggleSubdeckBtn" class="btn ghost small" aria-controls="newSubdeck" aria-expanded="false">+ Sub-deck (optional)</button>
            <input id="newSubdeck" class="input hidden" placeholder="e.g., Latte Art">
          </div>
          <div class="mt-sm"><button id="addDeckBtn" class="btn primary">Create / Select Deck</button></div>
        </div>

        <div class="mt select-wrap">
          <label class="label" for="deckSelect">Pick Existing Deck (by Name)</label>
          <select id="deckSelect" class="input" aria-label="Pick Deck (by Name)"></select>
          <div id="deckMeta" class="hint mt-sm">
            <span id="deckMetaTitle"></span>
            <div id="deckMetaSubs" class="micro"></div>
          </div>
        </div>
      </div>

      <details class="card bulk-card">
        <summary class="card-head">Bulk Add (tap for format)</summary>
        <div class="mt-sm"><button id="bulkSummaryBtn" class="btn ghost small">Show format</button></div>
        <textarea id="bulkTextarea" class="textarea mt" rows="5"
          placeholder="Question | Correct | Wrong1 | Wrong2 | Wrong3 | #Sub-deck(optional)"></textarea>
        <div class="mt"><button id="bulkAddBtn" class="btn primary">Add to Deck</button></div>
      </details>

      <div class="card danger-card">
        <div class="card-head">
          <strong>Delete (Decks / Sub-decks / Classes)</strong>
          <span class="hint">Removes items from local storage. You can optionally push deletions to the Cloud.</span>
        </div>
        <div class="grid g3 mt">
          <button id="deleteDeckHardBtn" class="btn danger">Delete Selected Deck</button>
          <button id="deleteSubdeckBtn" class="btn danger">Delete Selected Sub-deck</button>
          <button id="deleteClassBtn" class="btn danger">Delete Selected Class</button>
        </div>
      </div>

      <div class="card folder-card">
        <div class="card-head">
          <strong>Folders &amp; Subfolders</strong>
          <span class="hint">Select a folder to filter cards or add new subfolders.</span>
        </div>
        <div id="folderTree" class="folder-tree" aria-live="polite"></div>
      </div>

      <div class="card primary-card">
        <div class="card-head">
          <h3>Add / Edit Card</h3>
          <div class="grow"></div>
          <button id="cancelCardEditBtn" class="btn ghost small hidden">Cancel Edit</button>
        </div>
        <div class="grid g2 mt">
          <input id="qInput" class="input" placeholder="Question" aria-label="Question">
          <input id="aCorrectInput" class="input" placeholder="Correct answer" aria-label="Correct answer">
          <input id="aWrong1Input" class="input" placeholder="Wrong answer 1 (required)" aria-label="Wrong answer 1">
          <input id="aWrong2Input" class="input" placeholder="Wrong answer 2 (optional)" aria-label="Wrong answer 2">
          <input id="aWrong3Input" class="input" placeholder="Wrong answer 3 (optional)" aria-label="Wrong answer 3">
          <input id="cardSubInput" class="input" placeholder="Card sub-deck (optional)" aria-label="Card sub-deck">
        </div>
        <div class="mt actions-row">
          <button id="addCardBtn" class="btn primary">Save Card</button>
          <button id="saveCardCloudBtn" class="btn">Save + Push to Cloud</button>
        </div>

        <details class="mt card" id="subdeckManager" open>
          <summary class="card-head">Sub-decks in this Deck</summary>
          <div id="subdeckManagerList" class="chips mt"></div>
          <div class="grid g2 mt">
            <input id="subdeckNewName" class="input" placeholder="Add new sub-deck (tag)">
            <button id="createSubdeckBtn" class="btn">Add Sub-deck</button>
          </div>
        </details>
      </div>

      <div class="card filters-card">
        <h3>Cards in Deck</h3>

        <!-- Sub-deck viewer filter -->
        <div class="select-wrap mt-sm">
          <label class="label" for="cardsSubFilter">Show sub-deck</label>
          <select id="cardsSubFilter" class="input" aria-label="Filter cards by sub-deck">
            <!-- JS populates options; default is “All sub-decks” -->
          </select>
        </div>

        <div id="cardsList" class="list" aria-live="polite"></div>
      </div>
    </section>

    <!-- ========================= BUILD ========================= -->
    <section id="view-build" class="view" aria-labelledby="build-title">
      <h2 id="build-title">Quiz Builder &amp; Share</h2>

      <div class="card">
        <label class="switch">
          <input type="checkbox" id="previewToggle">
          <span>Preview as Barista</span>
        </label>

        <h3 class="step-title"><span class="step-num">1</span>Name the Test</h3>
        <div class="grid g3 mt">
          <div>
            <label class="label" for="testNameInput">Create or select a Test</label>
            <input id="testNameInput" class="input" list="testsList" placeholder="Type a new Test name or select" autocomplete="off">
            <datalist id="testsList"></datalist>
            <div class="mt-sm">
              <button id="saveTestBtn" class="btn primary">Save/Select Test</button>
              <button id="renameTestBtn" class="btn ghost">Rename Test</button>
              <button id="deleteTestBtn" class="btn danger">Delete Test</button>
            </div>
          </div>
          <div>
            <label class="label" for="builderTitle">Title shown to barista</label>
            <input id="builderTitle" class="input" placeholder="e.g., Barista Basics">
          </div>
          <div>
            <label class="label" for="builderCount">Total Questions</label>
            <input id="builderCount" type="number" min="1" class="input small" value="30">
          </div>
        </div>

        <h3 class="step-title mt"><span class="step-num">2</span>Select decks &amp; sub-decks</h3>
        <details id="deckChooser" class="card mt" open>
          <summary class="card-head">Choose decks (✓ whole deck or expand to pick sub-decks)</summary>
          <div class="select-wrap mt-sm">
            <label class="label" for="builderClassSelect">Class</label>
            <select id="builderClassSelect" class="input">
              <option value="">All classes</option>
            </select>
          </div>
          <div id="deckPickList" class="deck-pick"></div>
        </details>

        <h3 class="step-title mt"><span class="step-num">3</span>Save &amp; push to Cloud</h3>
        <div class="mt-sm">
          <button id="buildPushBtn" class="btn success">Push Test to Cloud</button>
          <p class="hint mt-sm">This saves your test and syncs it to Google Sheets so baristas can access it on their devices.</p>
        </div>

        <h3 class="step-title mt"><span class="step-num">4</span>Share the barista link</h3>
        <div class="mt-sm">
          <button id="copyShareBtn" class="btn success">Copy Student Link</button>
          <button id="openShareBtn" class="btn">Open Student Preview</button>
          <p class="hint mt-sm">Student link is restricted: no Create/Build/Reports; only the shared Test is visible.</p>
        </div>
      </div>

      <div id="previewPanel" class="card hidden">
        <h3 id="previewTitle">Preview</h3>
        <div class="hint" id="previewMeta" aria-live="polite"></div>
        <div class="mt">
          <button id="previewPracticeBtn" class="btn">Preview Practice</button>
          <button id="previewQuizBtn" class="btn primary">Preview Quiz</button>
        </div>
      </div>
    </section>

    <!-- ========================= PRACTICE ====================== -->
    <section id="view-practice" class="view" aria-labelledby="practice-title">
      <h2 id="practice-title">Practice</h2>

      <div class="card">
        <h3 id="practiceQuizTitle" class="mt-xs">Practice for this quiz</h3>
        <div class="grid g2">
          <div class="select-wrap">
            <label class="label" for="practiceTestSelect">Select Test</label>
            <select id="practiceTestSelect" class="input" aria-label="Select Test for Practice"></select>
          </div>
          <div class="hint mt-sm">
            <span id="practiceDeckHint">Pick which decks you want to study</span>
            <div class="micro mt-xs">Hotkeys: <kbd>Space</kbd> flip • <kbd>←</kbd>/<kbd>→</kbd> prev/next</div>
          </div>
        </div>
        <details class="mt" id="practiceDeckChooser">
          <summary class="card-head btn-like">Choose decks to study</summary>
          <div id="practiceDeckChecks" class="chips mt"></div>
        </details>
        <button id="startPracticeBtn" class="btn primary mt">Start Practice</button>
      </div>

      <div id="practiceArea" class="card" hidden>
        <div class="bar">
          <span id="practiceLabel">Studying…</span>
          <div class="grow"></div>
          <span id="practiceProgress" class="hint" aria-live="polite"></span>
        </div>
        <div id="practiceCard" class="flip mt" tabindex="0" aria-label="Flashcard">
          <div class="front">
            <div class="fc-title">Question</div>
            <div id="practiceQuestion" class="fc-text"></div>
            <div class="hint mt-sm">Tap or press <kbd>Space</kbd> to flip</div>
          </div>
          <div class="back">
            <div class="fc-title">Answer</div>
            <div id="practiceAnswer" class="fc-text"></div>
          </div>
        </div>
        <div class="mt grid g3">
          <button id="practicePrev" class="btn">Prev</button>
          <button id="practiceShuffle" class="btn ghost">Shuffle</button>
          <button id="practiceNext" class="btn">Next</button>
        </div>
      </div>
    </section>

    <!-- =========================== QUIZ ======================== -->
    <section id="view-quiz" class="view" aria-labelledby="quiz-title">
      <h2 id="quiz-title">Quiz</h2>

      <div class="card">
        <div class="grid g3">
          <div class="select-wrap">
            <label class="label" for="quizTestSelect">Select Test</label>
            <select id="quizTestSelect" class="input"></select>
          </div>
          <input id="studentName" class="input" placeholder="Your name (required)" aria-label="Your name">

          <!-- Location: dropdown with "Other…" text field -->
          <div class="select-wrap">
            <label class="label" for="studentLocationSelect">Location</label>
            <select id="studentLocationSelect" class="input" aria-label="Location">
              <option value="" disabled selected>Choose location…</option>
              <option>Huffman</option>
              <option>Camelot</option>
              <option>Muldoon</option>
              <option>Boniface</option>
              <option>Lake Otis</option>
              <option>Office</option>
              <option value="__OTHER__">Other…</option>
            </select>
            <input id="studentLocationOther" class="input mt-sm hidden" placeholder="Type location…" aria-label="Other location">
          </div>
        </div>

        <div class="mt">
          <label class="label" for="studentDate">Date</label>
          <input id="studentDate" class="input" type="date">
        </div>
        <div class="micro hint mt-sm">Hotkeys: <kbd>1</kbd>–<kbd>4</kbd> pick • <kbd>←</kbd>/<kbd>→</kbd> prev/next</div>
      </div>

      <div id="quizArea" class="card">
        <div class="bar">
          <span id="quizQuestion" class="qtxt"></span>
          <div class="grow"></div>
          <span id="quizProgress" class="hint" aria-live="polite"></span>
        </div>
        <div id="quizOptions" class="options mt" role="group" aria-label="Answer choices"></div>
        <div class="mt grid g3">
          <button id="quizPrev" class="btn">Prev</button>
          <button id="submitQuizBtn" class="btn primary">Submit</button>
          <button id="quizNext" class="btn">Next</button>
        </div>
      </div>

      <div id="quizFinished" class="card hidden">
        <h3>Finished!</h3>
        <p id="finishedMsg" class="lead"></p>
        <details open class="answer-key">
          <summary class="card-head">Your Answers &amp; Key</summary>
          <div id="finishedAnswers" class="answers mt"></div>
        </details>
        <div class="mt grid g2">
          <button id="restartQuizBtn" class="btn">Restart with fresh questions</button>
          <button id="finishedPracticeBtn" class="btn ghost">Go to Practice</button>
        </div>
      </div>
    </section>

    <!-- ========================= GRADES ======================== -->
    <section id="view-grades" class="view" aria-labelledby="grades-title">
      <h2 id="grades-title">Grades</h2>
      <div class="card">
        <p class="hint">This history is saved only on this device.</p>
        <div id="gradesList" class="list mt" aria-live="polite"></div>
      </div>
    </section>

    <!-- ====================== LEADERBOARDS ===================== -->
    <section id="view-leaderboards" class="view" aria-labelledby="leaderboards-title">
      <h2 id="leaderboards-title">Leaderboards</h2>
      <div class="card">
        <div class="card-head">
          <strong>Top Scores</strong>
          <button id="leaderboardRefreshBtn" class="btn ghost">Refresh from Cloud</button>
        </div>
        <div id="leaderboardList" class="list mt" aria-live="polite"></div>
      </div>
      <div class="card">
        <h3>Location Performance</h3>
        <div id="leaderboardLocations" class="report-list"></div>
      </div>
    </section>

    <!-- ========================= REPORTS ======================= -->
    <section id="view-reports" class="view" aria-labelledby="reports-title">
      <h2 id="reports-title">Reports</h2>

      <div class="card">
        <div class="grid g3">
          <div class="select-wrap">
            <label class="label" for="repLocation">Location</label>
            <select id="repLocation" class="input">
              <option value="">All locations</option>
            </select>
          </div>
          <div class="select-wrap">
            <label class="label" for="repAttemptView">Attempts</label>
            <select id="repAttemptView" class="input">
              <option value="all">All attempts</option>
              <option value="first">First attempt only</option>
              <option value="last">Last attempt only</option>
            </select>
          </div>
          <div class="select-wrap">
            <label class="label" for="repSort">Sort</label>
            <select id="repSort" class="input">
              <option value="date_desc">Newest first</option>
              <option value="date_asc">Oldest first</option>
              <option value="test_asc">Test A→Z</option>
              <option value="test_desc">Test Z→A</option>
              <option value="loc_asc">Location A→Z</option>
              <option value="loc_desc">Location Z→A</option>
            </select>
          </div>
        </div>

        <!-- Date range + Test filters -->
        <div class="grid g3 mt">
          <div>
            <label class="label" for="repDateFrom">Date from</label>
            <input id="repDateFrom" class="input" type="date" aria-label="Filter results from date">
          </div>
          <div>
            <label class="label" for="repDateTo">Date to</label>
            <input id="repDateTo" class="input" type="date" aria-label="Filter results to date">
          </div>
          <div class="select-wrap">
            <label class="label" for="repTest">Test</label>
            <select id="repTest" class="input" aria-label="Filter by test name">
              <option value="">All tests</option>
              <!-- JS populates test names -->
            </select>
          </div>
        </div>

        <div class="grid g2 mt">
          <div class="select-wrap">
            <label class="label" for="repView">View</label>
            <select id="repView" class="input">
              <option value="active">Active results</option>
              <option value="archived">Archived results</option>
            </select>
          </div>

          <!-- One-click refresh from cloud for reports -->
          <div class="mt-sm" style="display:flex;align-items:flex-end;justify-content:flex-end">
            <button id="repCloudPullBtn" class="btn ghost" title="Refresh Results/Tests from Google Sheets">Refresh from Cloud</button>
          </div>
        </div>
      </div>

      <div class="grid g3 report-kpis">
        <div class="card kpi-card">
          <div class="kpi-label">Attempts</div>
          <div class="kpi-value" id="kpiAttempts">0</div>
        </div>
        <div class="card kpi-card">
          <div class="kpi-label">Average Score</div>
          <div class="kpi-value" id="kpiAverage">0%</div>
        </div>
        <div class="card kpi-card">
          <div class="kpi-label">Unique Baristas</div>
          <div class="kpi-value" id="kpiUnique">0</div>
        </div>
      </div>

      <div class="card report-panel">
        <div class="card-head">
          <strong>Test Breakdown</strong>
          <span class="hint">Open any test to see the detailed attempts below.</span>
        </div>
        <div id="testBreakdown" class="report-list"></div>
      </div>

      <div class="card report-panel">
        <div class="card-head">
          <strong>Location Overview</strong>
          <span class="hint">Attempts and average scores by location.</span>
        </div>
        <div id="locationCharts" class="chart-grid"></div>
      </div>

      <!-- Location Averages -->
      <div class="card" id="locAvgCard">
        <h3>Location Averages</h3>
        <div id="locationAverages" class="missed"></div>
      </div>

      <div class="card report-panel">
        <div class="card-head">
          <strong>Location Progress</strong>
          <span class="hint">Recent score trends by location.</span>
        </div>
        <div id="locationTrends" class="trend-grid"></div>
      </div>

      <div class="card table-wrap">
        <table id="repTable" class="table">
          <thead>
            <tr>
              <th>Date/Time</th>
              <th>Name</th>
              <th>Location</th>
              <th>Test</th>
              <th>Score</th>
              <th>Correct</th>
              <th>View</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Most Missed Questions</h3>
        <div id="missedSummary" class="missed"></div>
      </div>
    </section>

    <!-- ========================= QUIZZES ======================= -->
    <section id="view-quizzes" class="view" aria-labelledby="quizzes-title">
      <h2 id="quizzes-title">Quizzes</h2>
      <div class="card">
        <div class="card-head">
          <strong>Existing Quizzes</strong>
          <span class="hint">Select a quiz to copy its student link.</span>
        </div>
        <div class="select-wrap mt-sm">
          <label class="label" for="quizShareSelect">Choose quiz</label>
          <select id="quizShareSelect" class="input"></select>
        </div>
        <div class="mt">
          <button id="quizShareCopyBtn" class="btn success">Copy Quiz Link</button>
          <button id="quizShareOpenBtn" class="btn">Open Preview</button>
        </div>
      </div>
      <div class="card">
        <h3>All Quizzes</h3>
        <div id="quizShareList" class="list mt" aria-live="polite"></div>
      </div>
    </section>

    <!-- ========================= SETTINGS ======================= -->
    <section id="view-settings" class="view" aria-labelledby="settings-title">
      <h2 id="settings-title">Settings &amp; Sync</h2>

      <div class="card">
        <div class="card-head">
          <strong>Cloud Sync &amp; Backups</strong>
          <div class="grow"></div>
          <button id="cloudPullBtn" class="btn ghost" title="Fetch Decks/Cards/Tests from Google Sheets">Pull from Cloud</button>
          <button id="cloudPushBtn" class="btn" title="Push full backup to Google Sheets (Merge/Replace)">Push Backup</button>
          <!-- JS injects Export All / Import Backup buttons here -->
        </div>
        <p class="hint mt-sm">Local changes save automatically. Use Pull to refresh from Sheets or Push to back up your current library.</p>
      </div>

      <div class="card bulk-card">
        <div class="card-head">
          <strong>Bulk Add Across Folders</strong>
          <span class="hint">Creates folders/subfolders when names match or are new.</span>
        </div>
        <p class="hint mt-sm">Format per line: <code>Class | Deck | Question | Correct | Wrong1 | Wrong2 | Wrong3 | #Subdeck(optional)</code></p>
        <textarea id="bulkGlobalTextarea" class="textarea mt" rows="6"
          placeholder="Barista Training | Espresso Basics | What is crema? | Foam on espresso | Milk foam | Latte art | Whipped cream | #Shots"></textarea>
        <div class="mt">
          <button id="bulkGlobalAddBtn" class="btn primary">Bulk Add to Folders</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer" role="contentinfo">
    <span class="hint">Admin data stays in this browser (localStorage). Share the student link to restrict access.</span>
  </footer>

  <!-- Toast / Snackbar -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
